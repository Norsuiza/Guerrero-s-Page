<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Control de Flotilla</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Iconos -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Scrollbars suaves */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a0a0a0; }
        
        .day-cell {
            min-height: 80px; /* Altura mínima ajustada para tablets */
            transition: all 0.2s;
            touch-action: manipulation; /* Mejora respuesta táctil */
        }
        @media (min-width: 1024px) {
            .day-cell { min-height: 110px; }
        }

        .day-cell:active, .day-cell:hover {
            background-color: #f8fafc;
            border-color: #818cf8;
        }

        /* Ajuste para evitar scroll horizontal en toda la app, solo en el calendario si es necesario */
        .calendar-scroll-area {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Grid del calendario que no se colapsa demasiado */
        .calendar-min-width {
            min-width: 700px; /* Asegura que las celdas no se aplasten en móviles */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans h-screen flex flex-col overflow-hidden">

    <!-- Cabecera -->
    <header class="bg-indigo-700 text-white shadow-lg z-30 px-4 py-3 flex justify-between items-center shrink-0">
        <h1 class="text-lg md:text-xl font-bold flex items-center gap-2 truncate">
            <i class="fas fa-truck-moving"></i> 
            <span class="hidden md:inline">Logística & Finanzas</span>
            <span class="md:hidden">Logística</span>
        </h1>
        
        <div class="flex items-center space-x-2 bg-indigo-800 rounded-lg p-1 mx-2">
            <button onclick="changeMonth(-1)" class="p-2 md:p-1 px-3 hover:bg-indigo-600 rounded-lg transition active:bg-indigo-900">
                <i class="fas fa-chevron-left"></i>
            </button>
            <h2 id="currentMonthDisplay" class="text-base md:text-lg font-semibold min-w-[120px] md:min-w-[160px] text-center capitalize select-none">
                <!-- Mes dinámico -->
            </h2>
            <button onclick="changeMonth(1)" class="p-2 md:p-1 px-3 hover:bg-indigo-600 rounded-lg transition active:bg-indigo-900">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>

        <div>
            <button onclick="resetData()" class="text-xs text-indigo-200 hover:text-white underline p-2">
                <i class="fas fa-trash-alt md:hidden"></i>
                <span class="hidden md:inline">Resetear</span>
            </button>
        </div>
    </header>

    <!-- Contenedor Principal Responsive -->
    <!-- lg:flex-row significa que en tablets grandes/PC es fila, en el resto columna -->
    <div class="flex flex-1 overflow-hidden flex-col lg:flex-row">
        
        <!-- DASHBOARD / BARRA LATERAL -->
        <!-- Cambia de comportamiento según el tamaño:
             - Mobile: Stack vertical
             - Tablet (md): Fila horizontal (Stats a la izq, lista a la der)
             - Desktop (lg): Columna vertical a la izquierda completa
        -->
        <aside class="w-full lg:w-80 bg-white shadow-xl z-20 flex flex-col md:flex-row lg:flex-col lg:border-r border-b lg:border-b-0 border-gray-200 shrink-0 h-auto lg:h-full max-h-[40vh] md:max-h-[30vh] lg:max-h-full overflow-hidden">
            
            <!-- Sección Resumen -->
            <div class="p-3 md:p-4 border-b md:border-b-0 md:border-r lg:border-r-0 lg:border-b border-gray-100 md:w-1/2 lg:w-full shrink-0 bg-gray-50 lg:bg-white">
                <h3 class="text-gray-500 text-[10px] md:text-xs font-bold uppercase tracking-wider mb-2 lg:mb-4">Resumen del Mes</h3>
                
                <!-- Grid de tarjetas: 3 columnas en móvil/tablet, 1 columna en desktop -->
                <div class="grid grid-cols-3 gap-2 lg:grid-cols-1 lg:gap-0 lg:space-y-3">
                    <div class="bg-green-50 border border-green-100 rounded-lg p-2 md:p-3 text-center lg:text-left">
                        <div class="text-green-600 text-[10px] md:text-xs font-bold uppercase truncate">Ingresos</div>
                        <div class="text-sm md:text-xl lg:text-2xl font-bold text-green-700 truncate" id="statIncome">$0</div>
                    </div>
                    <div class="bg-red-50 border border-red-100 rounded-lg p-2 md:p-3 text-center lg:text-left">
                        <div class="text-red-600 text-[10px] md:text-xs font-bold uppercase truncate">Egresos</div>
                        <div class="text-sm md:text-xl lg:text-2xl font-bold text-red-700 truncate" id="statExpense">$0</div>
                    </div>
                    <div class="bg-indigo-50 border border-indigo-100 rounded-lg p-2 md:p-3 text-center lg:text-left">
                        <div class="text-indigo-600 text-[10px] md:text-xs font-bold uppercase truncate">Neto</div>
                        <div class="text-base md:text-2xl lg:text-3xl font-bold text-indigo-800 truncate" id="statBalance">$0</div>
                    </div>
                </div>
            </div>

            <!-- Sección Lista de Camiones -->
            <div class="p-3 md:p-4 md:w-1/2 lg:w-full flex-1 overflow-y-auto min-h-[100px]">
                <h3 class="text-gray-500 text-[10px] md:text-xs font-bold uppercase tracking-wider mb-2 md:mb-4 flex justify-between items-center sticky top-0 bg-white py-1">
                    <span>Rentabilidad Camión</span>
                    <i class="fas fa-chart-pie text-gray-300"></i>
                </h3>
                
                <div id="truckStatsList" class="space-y-2 md:space-y-3">
                    <!-- Lista generada por JS -->
                    <p class="text-xs text-gray-400 italic">Sin datos.</p>
                </div>
            </div>
        </aside>

        <!-- CALENDARIO -->
        <main class="flex-1 flex flex-col bg-gray-100 overflow-hidden relative">
            <!-- Cabecera de días -->
            <div class="grid grid-cols-7 bg-white border-b border-gray-200 text-center py-2 shrink-0 shadow-sm z-10 calendar-min-width overflow-hidden">
                <div class="font-bold text-gray-400 text-xs md:text-sm">DOM</div>
                <div class="font-bold text-gray-400 text-xs md:text-sm">LUN</div>
                <div class="font-bold text-gray-400 text-xs md:text-sm">MAR</div>
                <div class="font-bold text-gray-400 text-xs md:text-sm">MIÉ</div>
                <div class="font-bold text-gray-400 text-xs md:text-sm">JUE</div>
                <div class="font-bold text-gray-400 text-xs md:text-sm">VIE</div>
                <div class="font-bold text-gray-400 text-xs md:text-sm">SÁB</div>
            </div>

            <!-- Área Scrollable del Calendario -->
            <div class="flex-grow calendar-scroll-area p-2 md:p-4">
                <div class="calendar-wrapper h-full calendar-min-width">
                    <div id="calendarGrid" class="grid grid-cols-7 gap-1 md:gap-3 auto-rows-fr h-full">
                        <!-- Días generados por JS -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODAL -->
    <div id="transactionModal" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden z-50 flex justify-center items-center backdrop-blur-sm transition-opacity p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg flex flex-col max-h-[95vh] overflow-hidden">
            
            <div class="bg-indigo-700 p-4 text-white flex justify-between items-center shrink-0">
                <h3 class="text-lg font-bold flex items-center">
                    <span class="bg-white text-indigo-700 rounded-md px-2 py-1 mr-2 text-sm font-bold shadow-sm" id="modalDayNumber">00</span>
                    <span id="modalDateText" class="text-base md:text-lg">Fecha</span>
                </h3>
                <button onclick="closeModal()" class="hover:bg-indigo-600 p-2 rounded-full transition w-10 h-10 flex items-center justify-center">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <div class="p-4 md:p-6 overflow-y-auto flex-grow custom-scrollbar">
                <form id="transactionForm" class="space-y-4 mb-6 bg-gray-50 p-4 rounded-lg border border-gray-200 shadow-inner">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-xs font-bold text-gray-500 uppercase">Tipo</label>
                            <div class="relative">
                                <select id="typeInput" class="w-full mt-1 border border-gray-300 rounded-lg p-3 text-base focus:border-indigo-500 outline-none bg-white appearance-none">
                                    <option value="income">Ingreso (+)</option>
                                    <option value="expense">Egreso (-)</option>
                                </select>
                                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                                    <i class="fas fa-chevron-down text-xs"></i>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-500 uppercase">Monto</label>
                            <input type="number" id="amountInput" placeholder="0.00" step="0.01" required 
                                class="w-full mt-1 border border-gray-300 rounded-lg p-3 text-base focus:border-indigo-500 outline-none">
                        </div>
                    </div>

                    <!-- Inputs dinámicos con botones más grandes para touch -->
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase">Camión</label>
                        <div class="flex gap-2 mt-1">
                            <select id="truckInput" class="flex-grow border border-gray-300 rounded-lg p-3 bg-white outline-none text-base"></select>
                            <button type="button" onclick="addNewOption('trucks', 'truckInput')" class="bg-indigo-100 text-indigo-700 w-12 rounded-lg hover:bg-indigo-200 font-bold text-lg shadow-sm active:bg-indigo-300">+</button>
                        </div>
                    </div>

                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase">Chofer</label>
                        <div class="flex gap-2 mt-1">
                            <select id="driverInput" class="flex-grow border border-gray-300 rounded-lg p-3 bg-white outline-none text-base"></select>
                            <button type="button" onclick="addNewOption('drivers', 'driverInput')" class="bg-indigo-100 text-indigo-700 w-12 rounded-lg hover:bg-indigo-200 font-bold text-lg shadow-sm active:bg-indigo-300">+</button>
                        </div>
                    </div>

                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase">Descripción</label>
                        <div class="flex gap-2 mt-1">
                            <select id="descInput" class="flex-grow border border-gray-300 rounded-lg p-3 bg-white outline-none text-base"></select>
                            <button type="button" onclick="addNewOption('descriptions', 'descInput')" class="bg-indigo-100 text-indigo-700 w-12 rounded-lg hover:bg-indigo-200 font-bold text-lg shadow-sm active:bg-indigo-300">+</button>
                        </div>
                    </div>

                    <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg shadow-md transition transform active:scale-95 text-lg">
                        Guardar Movimiento
                    </button>
                </form>

                <h4 class="font-bold text-gray-700 text-xs md:text-sm uppercase border-b pb-2 mb-3">Movimientos del Día</h4>
                <div id="transactionsList" class="space-y-3 pb-4"></div>
            </div>

            <div class="bg-gray-100 p-4 flex justify-between items-center text-sm md:text-base border-t shrink-0 safe-area-bottom">
                <span class="text-green-700 font-bold">Ing: <span id="modalIncomeTotal">$0</span></span>
                <span class="text-red-700 font-bold">Egr: <span id="modalExpenseTotal">$0</span></span>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURACIÓN Y ESTADO ---
        let currentDate = new Date();
        let selectedDateKey = null; 
        
        let transactions = JSON.parse(localStorage.getItem('financeData')) || {};
        let settings = JSON.parse(localStorage.getItem('financeSettings')) || {
            trucks: [],
            drivers: [],
            descriptions: ['Ruta a Fabrica', 'Viaje Especial', 'Gasolina', 'Pago a Chofer', 'Mantenimiento']
        };

        const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

        // --- INICIO ---
        document.addEventListener('DOMContentLoaded', () => {
            renderCalendar();
            loadSelectOptions('trucks', 'truckInput');
            loadSelectOptions('drivers', 'driverInput');
            loadSelectOptions('descriptions', 'descInput');
        });

        // --- CALENDARIO Y ESTADÍSTICAS ---
        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const monthDisplay = document.getElementById('currentMonthDisplay');
            
            grid.innerHTML = '';
            
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            monthDisplay.innerText = `${monthNames[month]} ${year}`;

            const firstDayIndex = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // Calcular Estadísticas del Mes Actual
            calculateMonthlyStats(year, month, daysInMonth);

            // Celdas vacías
            for (let i = 0; i < firstDayIndex; i++) {
                grid.appendChild(document.createElement('div'));
            }

            // Celdas de días
            for (let day = 1; day <= daysInMonth; day++) {
                const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayData = transactions[dateKey] || [];
                
                const income = dayData.filter(t => t.type === 'income').reduce((acc, curr) => acc + curr.amount, 0);
                const expense = dayData.filter(t => t.type === 'expense').reduce((acc, curr) => acc + curr.amount, 0);
                const balance = income - expense;

                const cell = document.createElement('div');
                cell.className = 'day-cell bg-white rounded-lg border border-gray-200 p-1 md:p-2 cursor-pointer relative flex flex-col justify-between shadow-sm hover:shadow-md select-none';
                
                // Día Actual
                const today = new Date();
                if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                    cell.classList.add('ring-2', 'ring-indigo-400', 'bg-indigo-50');
                }

                // Resumen Visual en la Celda
                let financeSummary = '';
                if (income > 0 || expense > 0) {
                    financeSummary = `
                        <div class="mt-1 text-[10px] md:text-xs flex flex-col gap-0.5 md:gap-1 h-full justify-end">
                            ${income > 0 ? `<div class="bg-green-100 text-green-800 px-1 rounded flex justify-between font-bold overflow-hidden"><span>+</span><span class="truncate">$${income}</span></div>` : ''}
                            ${expense > 0 ? `<div class="bg-red-100 text-red-800 px-1 rounded flex justify-between font-bold overflow-hidden"><span>-</span><span class="truncate">$${expense}</span></div>` : ''}
                            <div class="font-bold text-right border-t border-gray-300 pt-0.5 ${balance >= 0 ? 'text-gray-800' : 'text-red-600'} truncate">
                                ${balance >= 0 ? '$' + balance : '-$' + Math.abs(balance)}
                            </div>
                        </div>
                    `;
                } else {
                     financeSummary = `<div class="flex-grow"></div>`; // Spacer
                }

                cell.innerHTML = `
                    <div class="font-bold text-gray-500 text-xs md:text-sm pl-1">${day}</div>
                    ${financeSummary}
                `;

                cell.onclick = () => openModal(dateKey, day);
                grid.appendChild(cell);
            }
        }

        function calculateMonthlyStats(year, month, daysInMonth) {
            let totalIncome = 0;
            let totalExpense = 0;
            let truckStats = {}; 

            for (let day = 1; day <= daysInMonth; day++) {
                const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayData = transactions[dateKey] || [];

                dayData.forEach(t => {
                    if (t.type === 'income') totalIncome += t.amount;
                    else totalExpense += t.amount;

                    const truckName = t.truck && t.truck !== "N/A" ? t.truck : "Sin asignar";
                    if (!truckStats[truckName]) {
                        truckStats[truckName] = { income: 0, expense: 0 };
                    }
                    if (t.type === 'income') truckStats[truckName].income += t.amount;
                    else truckStats[truckName].expense += t.amount;
                });
            }

            const totalBalance = totalIncome - totalExpense;

            document.getElementById('statIncome').innerText = '$' + totalIncome.toLocaleString();
            document.getElementById('statExpense').innerText = '$' + totalExpense.toLocaleString();
            document.getElementById('statBalance').innerText = '$' + totalBalance.toLocaleString();
            
            const balEl = document.getElementById('statBalance');
            if(totalBalance >= 0) balEl.className = "text-base md:text-2xl lg:text-3xl font-bold text-indigo-800 truncate";
            else balEl.className = "text-base md:text-2xl lg:text-3xl font-bold text-red-600 truncate";

            // Actualizar DOM Camiones
            const truckListEl = document.getElementById('truckStatsList');
            truckListEl.innerHTML = '';
            
            const sortedTrucks = Object.keys(truckStats).sort((a, b) => {
                const balanceA = truckStats[a].income - truckStats[a].expense;
                const balanceB = truckStats[b].income - truckStats[b].expense;
                return balanceB - balanceA;
            });

            if (sortedTrucks.length === 0) {
                truckListEl.innerHTML = '<p class="text-xs text-gray-400 italic text-center mt-2">No hay actividad.</p>';
            } else {
                sortedTrucks.forEach(truck => {
                    const data = truckStats[truck];
                    const balance = data.income - data.expense;
                    
                    const item = document.createElement('div');
                    item.className = 'flex justify-between items-center border-b border-gray-100 pb-2 last:border-0';
                    item.innerHTML = `
                        <div class="flex flex-col overflow-hidden mr-2">
                            <span class="font-bold text-xs md:text-sm text-gray-700 truncate" title="${truck}">
                                <i class="fas fa-truck text-[10px] text-indigo-400 mr-1"></i>${truck}
                            </span>
                            <span class="text-[10px] md:text-xs text-gray-400 truncate">Ing: $${data.income} / Gas: $${data.expense}</span>
                        </div>
                        <span class="font-bold text-xs md:text-sm whitespace-nowrap ${balance >= 0 ? 'text-green-600' : 'text-red-500'}">
                            ${balance >= 0 ? '+' : ''}$${balance.toLocaleString()}
                        </span>
                    `;
                    truckListEl.appendChild(item);
                });
            }
        }

        function changeMonth(direction) {
            currentDate.setMonth(currentDate.getMonth() + direction);
            renderCalendar();
        }

        // --- SISTEMA DE LISTAS ---
        function loadSelectOptions(key, id) {
            const select = document.getElementById(id);
            const items = settings[key] || [];
            select.innerHTML = '<option value="">-- Seleccionar --</option>';
            items.forEach(i => {
                const opt = document.createElement('option');
                opt.value = i;
                opt.text = i;
                select.add(opt);
            });
        }

        function addNewOption(key, id) {
            const map = { 'trucks': 'Placa/Número de Camión', 'drivers': 'Nombre de Chofer', 'descriptions': 'Descripción' };
            const val = prompt(`Añadir nuevo ${map[key]}:`);
            if (val && val.trim()) {
                const clean = val.trim();
                if (!settings[key].includes(clean)) {
                    settings[key].push(clean);
                    localStorage.setItem('financeSettings', JSON.stringify(settings));
                    loadSelectOptions(key, id);
                    document.getElementById(id).value = clean;
                }
            }
        }

        // --- MODAL Y FORMULARIO ---
        function openModal(dateKey, day) {
            selectedDateKey = dateKey;
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            document.getElementById('modalDayNumber').innerText = day;
            document.getElementById('modalDateText').innerText = `${monthNames[month]} ${year}`;
            
            document.getElementById('transactionModal').classList.remove('hidden');
            document.getElementById('amountInput').value = '';
            document.getElementById('amountInput').focus();
            
            renderTransactionsList();
        }

        function closeModal() {
            document.getElementById('transactionModal').classList.add('hidden');
            selectedDateKey = null;
            renderCalendar(); 
        }

        document.getElementById('transactionModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('transactionModal')) closeModal();
        });

        document.getElementById('transactionForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const type = document.getElementById('typeInput').value;
            const amount = parseFloat(document.getElementById('amountInput').value);
            const truck = document.getElementById('truckInput').value;
            const driver = document.getElementById('driverInput').value;
            const desc = document.getElementById('descInput').value;

            if (!selectedDateKey || isNaN(amount) || amount <= 0) return alert("Monto inválido");
            if (!desc) return alert("Selecciona una descripción");

            if (!transactions[selectedDateKey]) transactions[selectedDateKey] = [];

            transactions[selectedDateKey].push({
                id: Date.now(),
                type, amount, truck: truck || "N/A", driver: driver || "N/A", desc
            });

            saveData();
            document.getElementById('amountInput').value = '';
            document.getElementById('amountInput').focus();
            renderTransactionsList();
        });

        function deleteTransaction(id) {
            if (!transactions[selectedDateKey]) return;
            transactions[selectedDateKey] = transactions[selectedDateKey].filter(t => t.id !== id);
            if (transactions[selectedDateKey].length === 0) delete transactions[selectedDateKey];
            saveData();
            renderTransactionsList();
        }

        function renderTransactionsList() {
            const list = document.getElementById('transactionsList');
            const dayData = transactions[selectedDateKey] || [];
            list.innerHTML = '';
            
            let tIncome = 0, tExpense = 0;

            if (dayData.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-400 text-sm py-4">Sin movimientos</div>';
            } else {
                dayData.slice().reverse().forEach(t => {
                    if (t.type === 'income') tIncome += t.amount; else tExpense += t.amount;
                    
                    const div = document.createElement('div');
                    div.className = "bg-white p-3 rounded-lg border border-gray-200 shadow-sm flex justify-between items-center";
                    div.innerHTML = `
                        <div class="overflow-hidden mr-2">
                            <div class="font-bold text-gray-700 text-sm truncate">${t.desc}</div>
                            <div class="text-xs text-gray-500 truncate">
                                <i class="fas fa-truck text-[10px]"></i> ${t.truck} | <i class="fas fa-user text-[10px]"></i> ${t.driver}
                            </div>
                        </div>
                        <div class="text-right shrink-0">
                            <div class="font-bold ${t.type === 'income' ? 'text-green-600' : 'text-red-600'}">
                                ${t.type === 'income' ? '+' : '-'}$${t.amount}
                            </div>
                            <button onclick="deleteTransaction(${t.id})" class="text-xs text-red-300 hover:text-red-500 mt-1 p-1">Eliminar</button>
                        </div>
                    `;
                    list.appendChild(div);
                });
            }
            document.getElementById('modalIncomeTotal').innerText = '$' + tIncome;
            document.getElementById('modalExpenseTotal').innerText = '$' + tExpense;
        }

        function saveData() {
            localStorage.setItem('financeData', JSON.stringify(transactions));
        }

        function resetData() {
            if(confirm("¿Borrar TODOS los datos y reiniciar la app?")) {
                localStorage.clear();
                location.reload();
            }
        }
    </script>
</body>
</html>